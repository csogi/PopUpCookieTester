<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Browser Privacy Check</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{--ok:#1a7f37;--bad:#b3261e;--warn:#b26b00;--muted:#666}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:2rem;background:#f7f7f8;color:#111}
.wrap{max-width:900px;margin:0 auto}
h1{margin:0 0 .5rem}
.small{color:var(--muted);font-size:.92rem}
.card{background:#fff;border:1px solid #e6e6e9;border-radius:16px;padding:1rem 1.25rem;margin:1rem 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.row{display:flex;gap:1rem;align-items:center;justify-content:space-between;flex-wrap:wrap}
.btn{appearance:none;border:1px solid #111;border-radius:999px;padding:.6rem 1rem;background:#111;color:#fff;font-weight:600;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.status{display:inline-flex;align-items:center;gap:.5rem;font-weight:700}
.dot{width:.7rem;height:.7rem;border-radius:50%;background:#bbb}
.ok{color:var(--ok)} .ok .dot{background:var(--ok)}
.bad{color:var(--bad)} .bad .dot{background:var(--bad)}
.warn{color:var(--warn)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
pre{background:#f0f0f3;padding:.75rem;border-radius:10px;white-space:pre-wrap;word-break:break-word;max-height:280px;overflow:auto}
a{color:#0b57d0}
</style>
</head>
<body>
<div class="wrap">
  <h1>Browser Privacy Check</h1>
  <p class="small">
    This page checks pop-ups, first-party cookies, third-party cookies (via cross-site iframe), and a third-party popup.
    <br>
    <strong class="warn" id="schemeWarn" style="display:none">You’re on <span id="schemeLbl"></span>; please use http(s):// — cookies don’t work reliably on file://.</strong>
  </p>

  <!-- Pop-ups (same-origin) -->
  <div class="card">
    <div class="row">
      <div>
        <div class="status" id="popupStatus"><span class="dot"></span> Pop-ups: <span class="mono" id="popupText">not checked</span></div>
        <div class="small">Opens a tiny window on click (user gesture required) and closes it shortly after.</div>
      </div>
      <button class="btn" id="btnPopup">Test pop-ups</button>
    </div>
  </div>

  <!-- First-party cookies -->
  <div class="card">
    <div class="row">
      <div>
        <div class="status" id="fpCookieStatus"><span class="dot"></span> First-party cookies: <span class="mono" id="fpCookieText">not checked</span></div>
        <div class="small">Sets a cookie on this origin and reads it back.</div>
      </div>
      <button class="btn" id="btnFP">Test 1P cookies</button>
    </div>
  </div>

  <!-- Third-party cookies via cross-site iframe -->
  <div class="card">
    <div class="row">
      <div>
        <div class="status" id="tpCookieStatus"><span class="dot"></span> Third-party cookies: <span class="mono" id="tpCookieText">not checked</span></div>
        <div class="small">
          Loads a cross-site iframe that attempts to set <code>SameSite=None; Secure</code> and reports back.
        </div>
        <div class="small mono">Probe URL: <span id="probeUrlShown"></span></div>
      </div>
      <button class="btn" id="btnTP">Test 3P cookies</button>
    </div>
    <details style="margin-top:.5rem">
      <summary class="small">Details</summary>
      <pre id="detailsBox" class="mono small">No details yet.</pre>
    </details>
    <iframe id="probeFrame" title="3P Cookie Probe" style="display:none;width:0;height:0;border:0"></iframe>
  </div>

  <!-- Third-party popup -->
  <div class="card">
    <div class="row">
      <div>
        <div class="status" id="tpPopupStatus"><span class="dot"></span> Third-party popup: <span class="mono" id="tpPopupText">not checked</span></div>
        <div class="small">Opens a popup to a different origin. If blocked, a manual link will appear.</div>
        <div class="small mono">Popup URL: <span id="tpPopupUrlShown"></span></div>
      </div>
      <button class="btn" id="btnTPPopup">Test 3P popup</button>
    </div>
    <div class="small" id="tpPopupFallbackWrap" style="display:none;margin-top:.5rem">
      Popup blocked? <a id="tpPopupFallback" href="#" target="_blank" rel="noopener">Click to open manually</a>
    </div>
  </div>
</div>

<script>
  // ====== EDIT THESE to point at your other domain (prefer HTTPS) ======
  const PROBE_URL       = "https://www.seemycomp.com/3p-cookie-probe.html";
  const PROBE_POPUP_URL = "https://www.seemycomp.com/3p-popup-probe.html";
  // =====================================================================

  const els = {
    schemeWarn: document.getElementById('schemeWarn'),
    schemeLbl: document.getElementById('schemeLbl'),

    // popups
    btnPopup: document.getElementById('btnPopup'),
    popupStatus: document.getElementById('popupStatus'),
    popupText: document.getElementById('popupText'),

    // 1P cookies
    btnFP: document.getElementById('btnFP'),
    fpCookieStatus: document.getElementById('fpCookieStatus'),
    fpCookieText: document.getElementById('fpCookieText'),

    // 3P cookies
    btnTP: document.getElementById('btnTP'),
    tpCookieStatus: document.getElementById('tpCookieStatus'),
    tpCookieText: document.getElementById('tpCookieText'),
    probeFrame: document.getElementById('probeFrame'),
    probeUrlShown: document.getElementById('probeUrlShown'),
    detailsBox: document.getElementById('detailsBox'),

    // 3P popup
    btnTPPopup: document.getElementById('btnTPPopup'),
    tpPopupStatus: document.getElementById('tpPopupStatus'),
    tpPopupText: document.getElementById('tpPopupText'),
    tpPopupUrlShown: document.getElementById('tpPopupUrlShown'),
    tpPopupFallbackWrap: document.getElementById('tpPopupFallbackWrap'),
    tpPopupFallback: document.getElementById('tpPopupFallback'),
  };

  els.probeUrlShown.textContent = PROBE_URL;
  els.tpPopupUrlShown.textContent = PROBE_POPUP_URL;

  if (location.protocol !== 'http:' && location.protocol !== 'https:') {
    els.schemeWarn.style.display = 'inline';
    els.schemeLbl.textContent = location.protocol.replace(':','') + '://';
  }

  function setStatus(container, textEl, ok, okLabel, badLabel) {
    container.classList.remove('ok','bad');
    const dot = container.querySelector('.dot');
    if (ok) {
      container.classList.add('ok');
      textEl.textContent = okLabel;
      dot.style.background = getComputedStyle(document.documentElement).getPropertyValue('--ok');
    } else {
      container.classList.add('bad');
      textEl.textContent = badLabel;
      dot.style.background = getComputedStyle(document.documentElement).getPropertyValue('--bad');
    }
  }

  function logDetail(msg) {
    const now = new Date().toISOString();
    els.detailsBox.textContent += `\n[${now}] ${msg}`;
  }

  // ---- Pop-up test (same-origin) ----
  // ---- Pop-up test (robust, self-closing) ----
  els.btnPopup.addEventListener('click', () => {
    let w = null, opened = false, err = '';

    try {
      // Open a blank popup synchronously on the click gesture.
      // NOTE: no "noopener" here so we can also close it from the opener if needed.
      w = window.open('about:blank', 'popup_test', 'popup=1,width=360,height=240');
      opened = !!w && !w.closed;
    } catch (e) {
      err = e.message || String(e);
    }

    if (!opened) {
      setStatus(els.popupStatus, els.popupText, false, 'allowed', 'blocked');
      return;
    }

    // Write a tiny self-closing document into the popup
    try {
      w.document.open();
      w.document.write(
        '<!doctype html><html><head><meta charset="utf-8"><title>Pop-up test</title>' +
        '<meta name="viewport" content="width=device-width,initial-scale=1"></head>' +
        '<body style="font:14px system-ui;margin:12px">' +
        'Pop-up allowed ✅ — closing…' +
        '<script>setTimeout(function(){ try{ window.close(); }catch(e){} }, 600);<\/script>' +
        '</body></html>'
      );
      w.document.close();
    } catch (e) {
      // If writing fails, we’ll still try to close from the opener
    }

    // Update UI immediately
    setStatus(els.popupStatus, els.popupText, true, 'allowed (auto-closing...)', 'blocked');

    // Safety: if the popup didn’t self-close, try from the opener after a moment
    setTimeout(() => { try { if (w && !w.closed) w.close(); } catch(e){} }, 1500);

    // Final check: if it’s still open, let the user know to close it manually
    setTimeout(() => {
      try {
        if (w && !w.closed) {
          setStatus(els.popupStatus, els.popupText, true, 'opened (please close manually)', 'blocked');
        }
      } catch (e) {/* ignore */}
    }, 2500);
  });

  // ---- First-party cookie test ----
  els.btnFP.addEventListener('click', () => {
    const name = 'fp_cookie_test';
    const value = String(Date.now());
    let ok = false, err = '';
    try {
      document.cookie = `${name}=${value}; Max-Age=60; Path=/`;
      ok = document.cookie.includes(`${name}=${value}`);
    } catch(e) { err = e.message || String(e); }
    setStatus(els.fpCookieStatus, els.fpCookieText, ok, 'working', 'blocked or disabled');
    if (!ok) logDetail(`1P cookie: write/read failed. scheme=${location.protocol}, cookieEnabled=${navigator.cookieEnabled}, err=${err}`);
  });

  // ---- Third-party cookie test (cross-site HTTPS iframe + postMessage) ----
  els.btnTP.addEventListener('click', () => {
    els.tpCookieStatus.classList.remove('ok','bad');
    els.tpCookieText.textContent = 'checking...';
    els.tpCookieStatus.querySelector('.dot').style.background = '#bbb';

    if (!/^https:$/i.test(new URL(PROBE_URL).protocol)) {
      logDetail('3P cookie: PROBE_URL is not HTTPS — modern browsers require Secure for SameSite=None.');
    }

    const timeout = setTimeout(() => {
      setStatus(els.tpCookieStatus, els.tpCookieText, false, 'allowed', 'no response (blocked frame or network)');
      logDetail('3P cookie: no postMessage response from probe (likely blocked, mixed-content, or CSP).');
      window.removeEventListener('message', onMsg);
    }, 6000);

    function onMsg(ev) {
      // Expect { type: '3pc-result', allowed: boolean, detail?: string }
      if (!ev || !ev.data || ev.data.type !== '3pc-result') return;
      clearTimeout(timeout);
      window.removeEventListener('message', onMsg);
      const { allowed, detail } = ev.data;
      setStatus(els.tpCookieStatus, els.tpCookieText, !!allowed, 'allowed', 'blocked');
      logDetail(`3P cookie result from ${ev.origin}: allowed=${!!allowed}; detail=${detail || 'n/a'}`);
    }

    window.addEventListener('message', onMsg);
    els.probeFrame.src = PROBE_URL + (PROBE_URL.includes('?') ? '&' : '?') + 't=' + Date.now();
  });

  // ---- Third-party popup test ----
  // Receive ack from popup
  window.addEventListener('message', (ev) => {
    if (!ev || !ev.data || ev.data.type !== 'tp-popup-opened') return;
    setStatus(els.tpPopupStatus, els.tpPopupText, true, 'opened', 'blocked');
    els.tpPopupFallbackWrap.style.display = 'none';
  });

  els.btnTPPopup.addEventListener('click', () => {
    const url = PROBE_POPUP_URL + (PROBE_POPUP_URL.includes('?') ? '&' : '?') + 't=' + Date.now();
    let win = null;
    try { win = window.open(url, 'tp_probe', 'width=480,height=600,noopener'); } catch (e) {}
    const opened = !!win && !win.closed;

    if (opened) {
      setStatus(els.tpPopupStatus, els.tpPopupText, true, 'opened (awaiting ack...)', 'blocked');
      setTimeout(() => {
        if (els.tpPopupText.textContent.includes('awaiting')) {
          // Popup opened but no ack (content blocked / JS disabled / message blocked by policy)
          setStatus(els.tpPopupStatus, els.tpPopupText, true, 'opened (no ack)', 'blocked');
        }
      }, 4000);
    } else {
      setStatus(els.tpPopupStatus, els.tpPopupText, false, 'opened', 'blocked');
      // Show manual link fallback — many blockers allow a user-clicked <a target="_blank">
      els.tpPopupFallback.href = url;
      els.tpPopupFallbackWrap.style.display = 'inline';
    }
  });
</script>
</body>
</html>
